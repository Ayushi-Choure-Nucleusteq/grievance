<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>TicketServiceImpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">grievance</a> &gt; <a href="index.source.html" class="el_package">com.grievance.serviceimpl</a> &gt; <span class="el_source">TicketServiceImpl.java</span></div><h1>TicketServiceImpl.java</h1><pre class="source lang-java linenums">package com.grievance.serviceimpl;

import java.time.LocalDateTime;


import java.time.format.DateTimeFormatter;
import java.util.ArrayList;
import java.util.List;
import java.util.Objects;
import java.util.Optional;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.PageRequest;
import org.springframework.data.domain.Sort;
import org.springframework.stereotype.Service;

import com.grievance.entity.Comment;
import com.grievance.entity.Department;
import com.grievance.entity.Member;
import com.grievance.entity.Ticket;
import com.grievance.enums.MemberRole;
import com.grievance.enums.TicketStatus;
import com.grievance.exception.CannotEditTicketException;
import com.grievance.exception.ResourceNotFoundException;
import com.grievance.exception.UnauthorizedException;
import com.grievance.indto.TicketDto;
import com.grievance.outdto.TicketOutDto;
import com.grievance.repository.DepartmentRepo;
import com.grievance.repository.MemberRepo;
import com.grievance.repository.TicketRepo;
import com.grievance.service.TicketService;

/**
 * Service implementation for ticket operations.
 */
@Service
<span class="fc" id="L40">public final class TicketServiceImpl implements TicketService {</span>
    
    /**
     * Loggers.
     */
<span class="fc" id="L45">    private static final Logger LOGGER = LoggerFactory</span>
<span class="fc" id="L46">            .getLogger(TicketServiceImpl.class);</span>

    /** Repository for ticket-related operations. */
    @Autowired
    private TicketRepo ticketRepo;

    /** Repository for member-related operations. */
    @Autowired
    private MemberRepo memberRepo;

    /** Repository for department-related operations. */
    @Autowired
    private DepartmentRepo deptRepo;

    /**
	 * Conversion for conversion from indto to entity to outdto.
	 */
	@Autowired
	private Conversion conversion;

	/**
	 * Create a ticket based on the provided ticket DTO.
	 *
	 * @param ticketDto the ticket data transfer object
	 * @return the output DTO of the created ticket
	 */
	@Override
	public TicketOutDto createTicket(final TicketDto ticketDto,
			final String email, final String password)
			throws ResourceNotFoundException {
<span class="fc" id="L76">	    LOGGER.info(&quot;Creating a new ticket for email: {}&quot;, email);</span>
<span class="pc bpc" id="L77" title="1 of 2 branches missed.">		if (!ticketDto.getMember().getEmail().equals(email)) {</span>
<span class="nc" id="L78">		    LOGGER.error(&quot;Unauthorized attempt &quot;</span>
		            + &quot;to create a ticket with mismatched email&quot;);
<span class="nc" id="L80">			throw new UnauthorizedException(&quot;Inavlid Details.&quot;);</span>
		}
<span class="fc" id="L82">		Member existingMember = memberRepo.findByEmail(</span>
<span class="fc" id="L83">				ticketDto.getMember().getEmail());</span>

<span class="fc bfc" id="L85" title="All 2 branches covered.">		if (Objects.isNull(existingMember)) {</span>
<span class="fc" id="L86">		    LOGGER.error(&quot;Email not exists {}&quot;, email);</span>
<span class="fc" id="L87">			throw new ResourceNotFoundException(</span>
			  &quot;The member associated does not exist.&quot;);
		}
<span class="fc" id="L90">		LOGGER.info(&quot;Found member details for email: {}&quot;, email);</span>

<span class="fc" id="L92">		Department department = deptRepo.findByDeptName(</span>
<span class="fc" id="L93">				ticketDto.getDepartment().getDeptName());</span>

<span class="fc bfc" id="L95" title="All 2 branches covered.">		if (Objects.isNull(department)) {</span>
<span class="fc" id="L96">		    LOGGER.error(&quot;Department not exists {}&quot;,</span>
<span class="fc" id="L97">		            ticketDto.getDepartment().getDeptName());</span>
<span class="fc" id="L98">			throw new ResourceNotFoundException(</span>
			  &quot;The department does not exist.&quot;);
		}
<span class="fc" id="L101">		 LOGGER.info(&quot;Found department details for&quot;</span>
		         + &quot; department name: {}&quot;,
<span class="fc" id="L103">		         ticketDto.getDepartment().getDeptName());</span>
<span class="fc" id="L104">		ticketDto.setComments(null);</span>
<span class="fc" id="L105">		Ticket ticket = conversion.ticketdtoToTicket(</span>
				ticketDto);
<span class="fc" id="L107">		ticket.setMember(existingMember);</span>
<span class="fc" id="L108">		ticket.setDepartment(department);</span>
<span class="fc" id="L109">		String creationDate = LocalDateTime.now().format(</span>
<span class="fc" id="L110">		DateTimeFormatter.ofPattern(&quot;yyyy/MM/dd HH:mm:ss&quot;));</span>
<span class="fc" id="L111">		ticket.setCreationDate(creationDate);</span>
<span class="fc" id="L112">		ticket.setLastUpdateDate(creationDate);</span>
<span class="fc" id="L113">		ticket.setStatus(TicketStatus.OPEN);</span>
<span class="fc" id="L114">		Ticket savedTicket = ticketRepo.save(ticket);</span>
<span class="fc" id="L115">		 LOGGER.info(&quot;Ticket created successfully with ID: {}&quot;,</span>
<span class="fc" id="L116">		         savedTicket.getTicketId());</span>

<span class="fc" id="L118">		return conversion.ticketToOutDto(savedTicket);</span>
	}

	/**
	 *
	 * To fetch a ticket by its ID.
	 *
	 *@param ticketId
	 *@param email
	 *@param password
	 *@return ticketOutDto
	 *@throws ResourceNotFoundexception
	 */
	@Override
	public TicketOutDto getById(final Integer ticketId,
			final String email, final String password)
			throws ResourceNotFoundException {
<span class="fc" id="L135">	    LOGGER.info(&quot;Fetching ticket by ID: {}&quot;, ticketId);</span>
<span class="fc" id="L136">		Ticket ticket = ticketRepo.findByticketId(ticketId);</span>
<span class="fc bfc" id="L137" title="All 2 branches covered.">		if (Objects.isNull(ticket)) {</span>
<span class="fc" id="L138">		    LOGGER.error(&quot;No ticket found &quot;</span>
		            + &quot;with Id {}&quot;, ticketId);
<span class="fc" id="L140">			throw new ResourceNotFoundException(</span>
					&quot;Ticket with this Id does not exists&quot;);
		}
<span class="fc" id="L143">		LOGGER.info(&quot;Successfully fetched ticket details &quot;</span>
		        + &quot;for ID: {} for user: {}&quot;, ticketId, email);
<span class="fc" id="L145">		return conversion.ticketToOutDto(ticket);</span>
	}

	/**
	 * Fetch tickets based on the provided email and password.
	 *
	 * @param email
	 * @param password
	 * @param myTicket
	 * @param pageNo
	 * @return the output DTO of the created ticket
	 */
	@Override
	public List&lt;TicketOutDto&gt; getAllTicketsAuth(final String email,
			final String password, final boolean myTicket,
			final Integer pageNo) {
<span class="fc" id="L161">	    LOGGER.info(&quot;Initiating request to fetch tickets&quot;</span>
	            + &quot; for user: {}&quot;, email);
<span class="fc" id="L163">		final Integer pageSize = 5;</span>
<span class="fc" id="L164">		Member member = memberRepo.findByEmail(email);</span>
<span class="fc" id="L165">		LOGGER.info(&quot;Member with email {} has role: {}&quot;,</span>
<span class="fc" id="L166">		        email, member.getRole());</span>
<span class="fc" id="L167">		Page&lt;Ticket&gt; tickets = ticketRepo.findAll(</span>
<span class="fc" id="L168">		  PageRequest.of(pageNo, pageSize, Sort.by(&quot;status&quot;)));</span>
<span class="fc bfc" id="L169" title="All 2 branches covered.">		if (tickets.isEmpty()) {</span>
<span class="fc" id="L170">		    LOGGER.warn(&quot;No tickets found&quot;);</span>
<span class="fc" id="L171">			throw new ResourceNotFoundException(&quot;No Ticket found.&quot;);</span>
		}
<span class="fc" id="L173">		List&lt;TicketOutDto&gt; ticketDtos = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L174" title="All 2 branches covered.">		if (myTicket) {</span>
<span class="fc" id="L175">			tickets = (Page&lt;Ticket&gt;) ticketRepo.findByMember(member,</span>
<span class="fc" id="L176">			  PageRequest.of(pageNo, pageSize, Sort.by(</span>
					  &quot;status&quot;)));
<span class="pc bpc" id="L178" title="1 of 2 branches missed.">			if (tickets.isEmpty()) {</span>
<span class="nc" id="L179">			    LOGGER.warn(&quot;No Personal tickets found&quot;);</span>
<span class="nc" id="L180">	            throw new ResourceNotFoundException(&quot;No Ticket found.&quot;);</span>
			}
<span class="fc bfc" id="L182" title="All 2 branches covered.">			for (Ticket ticket : tickets) {</span>
<span class="fc" id="L183">			  ticketDtos.add(conversion.ticketToOutDto(ticket));</span>
<span class="fc" id="L184">			}</span>
<span class="fc" id="L185">			LOGGER.info(&quot;Fetching personal tickets for member&quot;</span>
			        + &quot; with email: {}&quot;, email);
<span class="fc bfc" id="L187" title="All 2 branches covered.">		} else if (member.getRole().equals(MemberRole.ADMIN)) {</span>
<span class="fc bfc" id="L188" title="All 2 branches covered.">			for (Ticket ticket : tickets) {</span>
<span class="fc" id="L189">			  ticketDtos.add(conversion.ticketToOutDto(ticket));</span>
<span class="fc" id="L190">			}</span>
<span class="fc" id="L191">			 LOGGER.info(&quot;Fetching all tickets for ADMIN&quot;);</span>
<span class="pc bpc" id="L192" title="1 of 2 branches missed.">		} else if (member.getRole().equals(MemberRole.MEMBER)) {</span>
<span class="fc" id="L193">			tickets = (Page&lt;Ticket&gt;) ticketRepo.</span>
<span class="fc" id="L194">				findByDepartment(member.getDepartment(),</span>
<span class="fc" id="L195">				  PageRequest.of(pageNo, pageSize, Sort.by(</span>
						  &quot;status&quot;)));
<span class="fc bfc" id="L197" title="All 2 branches covered.">			for (Ticket ticket : tickets) {</span>
<span class="fc" id="L198">		      ticketDtos.add(conversion.</span>
<span class="fc" id="L199">						ticketToOutDto(ticket));</span>
<span class="fc" id="L200">			}</span>
<span class="fc" id="L201">			 LOGGER.info(&quot;Fetching all tickets for MEMBER&quot;);</span>
		}


<span class="fc" id="L205">		return ticketDtos;</span>
	}
	
	/**
     * Fetch tickets based on the provided email and password.
     *
     * @param email
     * @param password
     * @param myTicket
     * @param pageNo
     * @param status
     * @return the output DTO of the created ticket
     */

	@Override
	public List&lt;TicketOutDto&gt; getAllTicketsFilter(final String email,
			final String password, final boolean myTicket,
			final Integer pageNo,
			final Optional&lt;TicketStatus&gt; status) {
<span class="fc" id="L224">	    LOGGER.info(&quot;Initiating request to fetch filtered&quot;</span>
	            + &quot; tickets for user: {}.&quot;, email);
<span class="fc" id="L226">		final Integer pageSize = 5;</span>
<span class="fc" id="L227">		Member member = memberRepo.findByEmail(email);</span>
<span class="fc" id="L228">		Page&lt;Ticket&gt; tickets = ticketRepo.findAllAndStatus(</span>
<span class="fc" id="L229">				PageRequest.of(pageNo, pageSize, Sort.by(</span>
						&quot;status&quot;)), status);
<span class="fc bfc" id="L231" title="All 2 branches covered.">		if (tickets.isEmpty()) {</span>
<span class="fc" id="L232">		    LOGGER.warn(&quot;No tickets found&quot;);</span>
<span class="fc" id="L233">			throw new ResourceNotFoundException(&quot;No Ticket found.&quot;);</span>
		}

<span class="fc" id="L236">		List&lt;TicketOutDto&gt; ticketDtos = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L237" title="All 2 branches covered.">		if (myTicket) {</span>
<span class="fc" id="L238">		    LOGGER.info(&quot;Fetching personal tickets&quot;);</span>
<span class="fc" id="L239">			tickets = (Page&lt;Ticket&gt;) ticketRepo.</span>
<span class="fc" id="L240">					findByMemberAndStatus(</span>
<span class="fc" id="L241">			member.getId(), status, PageRequest.of(</span>
<span class="fc" id="L242">				pageNo, pageSize, Sort.by(&quot;status&quot;)));</span>
<span class="pc bpc" id="L243" title="1 of 2 branches missed.">			if (tickets.isEmpty()) {</span>
<span class="nc" id="L244">                LOGGER.warn(&quot;No Personal tickets found&quot;);</span>
<span class="nc" id="L245">                throw new ResourceNotFoundException(&quot;No Ticket found.&quot;);</span>
            }
<span class="fc bfc" id="L247" title="All 2 branches covered.">			for (Ticket ticket : tickets) {</span>
<span class="fc" id="L248">			  ticketDtos.add(conversion.ticketToOutDto(ticket));</span>
<span class="fc" id="L249">			}</span>
<span class="fc bfc" id="L250" title="All 2 branches covered.">		} else if (member.getRole().equals(MemberRole.ADMIN)) {</span>
<span class="fc" id="L251">		    LOGGER.info(&quot;Fetching all tickets for ADMIN&quot;);</span>
<span class="fc bfc" id="L252" title="All 2 branches covered.">		    for (Ticket ticket : tickets) {</span>
<span class="fc" id="L253">			  ticketDtos.add(conversion.ticketToOutDto(ticket));</span>
<span class="fc" id="L254">			}</span>
<span class="pc bpc" id="L255" title="1 of 2 branches missed.">		} else if (member.getRole().equals(MemberRole.MEMBER)) {</span>
<span class="fc" id="L256">		    LOGGER.info(&quot;Fetching all tickets for MEMBER&quot;);</span>
<span class="fc" id="L257">		    tickets = (Page&lt;Ticket&gt;) ticketRepo</span>
<span class="fc" id="L258">			  .findByDepartmentAndStatus(member.getDepartment()</span>
<span class="fc" id="L259">				 .getDeptId(), status, PageRequest.of(</span>
<span class="fc" id="L260">				     pageNo, pageSize, Sort.by(&quot;status&quot;)));</span>
<span class="fc bfc" id="L261" title="All 2 branches covered.">			for (Ticket ticket : tickets) {</span>
<span class="fc" id="L262">		      ticketDtos.add(conversion.</span>
<span class="fc" id="L263">						ticketToOutDto(ticket));</span>
<span class="fc" id="L264">			}</span>
		}

<span class="fc" id="L267">		return ticketDtos;</span>
	}

	/**
	 * Update a ticket based on the provided ticket DTO.
	 *
	 * @param ticketDto the ticket data transfer object
	 * @param id   id of the ticket
	 * @param email		email of user
	 * @param password  password of user
	 * @return the output DTO of the created ticket
	 */
	@Override
	public TicketOutDto updateTicket(final TicketDto ticketDto,
			final Integer id, final String email,
			final String password) {
<span class="fc" id="L283">	    LOGGER.info(&quot;Initiating request to update &quot;</span>
	            + &quot;ticket with ID: {}&quot;, id);
<span class="fc" id="L285">		Optional&lt;Ticket&gt; ticket = ticketRepo.findById(id);</span>

<span class="fc bfc" id="L287" title="All 2 branches covered.">		if (!ticket.isPresent()) {</span>
<span class="fc" id="L288">		    LOGGER.error(&quot;No ticket found with ID: {}&quot;, id);</span>
<span class="fc" id="L289">			throw new ResourceNotFoundException(&quot;No Ticket Found&quot;);</span>
		}
<span class="fc bfc" id="L291" title="All 2 branches covered.">		if (!ticketDto.getMember().getEmail().equals(email)) {</span>
<span class="fc" id="L292">		    LOGGER.error(&quot;Mismatch in email for update request&quot;);</span>
<span class="fc" id="L293">			throw new UnauthorizedException(&quot;Inavlid Details.&quot;);</span>
		}
<span class="fc" id="L295">		Member member = memberRepo.findByEmail(</span>
<span class="fc" id="L296">				ticketDto.getMember().getEmail());</span>
<span class="fc bfc" id="L297" title="All 2 branches covered.">		if (Objects.isNull(member)) {</span>
<span class="fc" id="L298">		    LOGGER.error(&quot;No member associated with email:{}&quot;, email);</span>
<span class="fc" id="L299">			throw new ResourceNotFoundException(</span>
					&quot;User doesn't exists&quot;);
		}
<span class="fc" id="L302">		boolean isSameDepartment = ticket.get()</span>
<span class="fc" id="L303">		        .getDepartment().getDeptName()</span>
<span class="fc" id="L304">		        .equals(member.getDepartment().getDeptName());</span>
<span class="fc" id="L305">		boolean isSameEmail = member.getEmail()</span>
<span class="fc" id="L306">		        .equals(ticket.get().getMember().getEmail());</span>

<span class="pc bpc" id="L308" title="3 of 4 branches missed.">		if (!isSameDepartment &amp;&amp; !isSameEmail)  {</span>
<span class="nc" id="L309">		    LOGGER.error(&quot;User trying to update ticket from another &quot;</span>
		            + &quot;department or different member email.&quot;);
<span class="nc" id="L311">			throw new CannotEditTicketException(</span>
					&quot;You cannot update this ticket&quot;);
		}

<span class="fc" id="L315">		List&lt;Comment&gt; comments = ticket.get().getComments();</span>

<span class="fc bfc" id="L317" title="All 2 branches covered.">		if (ticketDto.getStatus().equals(TicketStatus.RESOLVED)</span>
<span class="pc bpc" id="L318" title="1 of 2 branches missed.">				&amp;&amp; Objects.isNull(ticketDto.getComments())) {</span>
<span class="fc" id="L319">		    LOGGER.warn(&quot;Attempt to set ticket status to &quot;</span>
		            + &quot;RESOLVED without adding comments.&quot;);
<span class="fc" id="L321">			throw new</span>
			CannotEditTicketException(
			 &quot;There must be a comment to resolve&quot;);
		}

<span class="fc" id="L326">		String updatedDate = LocalDateTime.now().format(</span>
<span class="fc" id="L327">				DateTimeFormatter.ofPattern(</span>
						&quot;yyyy/MM/dd HH:mm:ss&quot;));
<span class="fc" id="L329">		ticket.get().setLastUpdateDate(updatedDate);</span>
<span class="fc" id="L330">		ticket.get().setStatus(ticketDto.getStatus());</span>
<span class="fc" id="L331">		Comment newComment = new Comment();</span>
<span class="pc bpc" id="L332" title="1 of 2 branches missed.">		if (Objects.nonNull(ticketDto.getComments())) {</span>
<span class="nc" id="L333">		LOGGER.info(&quot;Updated comment entity for ticket ID: {}&quot;, id);    </span>
<span class="nc" id="L334">		newComment.setContent(ticketDto.getComments());</span>
<span class="nc" id="L335">		newComment.setCreationTime(updatedDate);</span>
<span class="nc" id="L336">		newComment.setMemberEmail(member.getEmail());</span>
<span class="nc" id="L337">		newComment.setTicket(ticket.get());</span>
<span class="nc" id="L338">		comments.add(newComment);</span>
<span class="nc" id="L339">		ticket.get().setComments(comments);</span>
<span class="nc" id="L340">		ticket.get().setTicketId(ticket.get().getTicketId());</span>
		}
<span class="fc" id="L342">		Ticket updatedTicket = ticketRepo.save(ticket.get());</span>
<span class="fc" id="L343">		LOGGER.info(&quot;Successfully updated ticket with ID: {}&quot;, id);</span>

<span class="fc" id="L345">		return conversion.ticketToOutDto(updatedTicket);</span>
	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span></div></body></html>